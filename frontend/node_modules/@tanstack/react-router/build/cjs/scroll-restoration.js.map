{"version":3,"file":"scroll-restoration.js","sources":["../../src/scroll-restoration.tsx"],"sourcesContent":["import * as React from 'react'\n\nconst useLayoutEffect =\n  typeof window !== 'undefined' ? React.useLayoutEffect : React.useEffect\n\nimport { ParsedLocation } from './location'\nimport { useRouter } from './RouterProvider'\nimport { NonNullableUpdater, functionalUpdate } from './utils'\n\nconst windowKey = 'window'\nconst delimiter = '___'\n\nlet weakScrolledElements = new WeakSet<any>()\n\ntype CacheValue = Record<string, { scrollX: number; scrollY: number }>\ntype CacheState = {\n  cached: CacheValue\n  next: CacheValue\n}\n\ntype Cache = {\n  state: CacheState\n  set: (updater: NonNullableUpdater<CacheState>) => void\n}\n\nconst sessionsStorage = typeof window !== 'undefined' && window.sessionStorage\n\nlet cache: Cache = sessionsStorage\n  ? (() => {\n      const storageKey = 'tsr-scroll-restoration-v2'\n\n      const state: CacheState = JSON.parse(\n        window.sessionStorage.getItem(storageKey) || 'null',\n      ) || { cached: {}, next: {} }\n\n      return {\n        state,\n        set: (updater) => {\n          cache.state = functionalUpdate(updater, cache.state)\n          window.sessionStorage.setItem(storageKey, JSON.stringify(cache.state))\n        },\n      }\n    })()\n  : (undefined as any)\n\nexport type ScrollRestorationOptions = {\n  getKey?: (location: ParsedLocation) => string\n}\n\nconst defaultGetKey = (location: ParsedLocation) => location.state.key!\n\nexport function useScrollRestoration(options?: ScrollRestorationOptions) {\n  const router = useRouter()\n\n  useLayoutEffect(() => {\n    const getKey = options?.getKey || defaultGetKey\n\n    const { history } = window\n    if (history.scrollRestoration) {\n      history.scrollRestoration = 'manual'\n    }\n\n    const onScroll = (event: Event) => {\n      if (weakScrolledElements.has(event.target)) return\n      weakScrolledElements.add(event.target)\n\n      let elementSelector = ''\n\n      if (event.target === document || event.target === window) {\n        elementSelector = windowKey\n      } else {\n        const attrId = (event.target as Element).getAttribute(\n          'data-scroll-restoration-id',\n        )\n\n        if (attrId) {\n          elementSelector = `[data-scroll-restoration-id=\"${attrId}\"]`\n        } else {\n          elementSelector = getCssSelector(event.target)\n        }\n      }\n\n      if (!cache.state.next[elementSelector]) {\n        cache.set((c) => ({\n          ...c,\n          next: {\n            ...c.next,\n            [elementSelector]: {\n              scrollX: NaN,\n              scrollY: NaN,\n            },\n          },\n        }))\n      }\n    }\n\n    if (typeof document !== 'undefined') {\n      document.addEventListener('scroll', onScroll, true)\n    }\n\n    const unsubOnBeforeLoad = router.subscribe('onBeforeLoad', (event) => {\n      if (event.pathChanged) {\n        const restoreKey = getKey(event.fromLocation)\n        for (const elementSelector in cache.state.next) {\n          const entry = cache.state.next[elementSelector]!\n          if (elementSelector === windowKey) {\n            entry.scrollX = window.scrollX || 0\n            entry.scrollY = window.scrollY || 0\n          } else if (elementSelector) {\n            const element = document.querySelector(elementSelector)\n            entry.scrollX = element?.scrollLeft || 0\n            entry.scrollY = element?.scrollTop || 0\n          }\n\n          cache.set((c) => {\n            const next = { ...c.next }\n            delete next[elementSelector]\n\n            return {\n              ...c,\n              next,\n              cached: {\n                ...c.cached,\n                [[restoreKey, elementSelector].join(delimiter)]: entry,\n              },\n            }\n          })\n        }\n      }\n    })\n\n    const unsubOnResolved = router.subscribe('onResolved', (event) => {\n      if (event.pathChanged) {\n        if (!router.resetNextScroll) {\n          return\n        }\n\n        router.resetNextScroll = true\n\n        const getKey = options?.getKey || defaultGetKey\n\n        const restoreKey = getKey(event.toLocation)\n        let windowRestored = false\n\n        for (const cacheKey in cache.state.cached) {\n          const entry = cache.state.cached[cacheKey]!\n          const [key, elementSelector] = cacheKey.split(delimiter)\n          if (key === restoreKey) {\n            if (elementSelector === windowKey) {\n              windowRestored = true\n              window.scrollTo(entry.scrollX, entry.scrollY)\n            } else if (elementSelector) {\n              const element = document.querySelector(elementSelector)\n              if (element) {\n                element.scrollLeft = entry.scrollX\n                element.scrollTop = entry.scrollY\n              }\n            }\n          }\n        }\n\n        if (!windowRestored) {\n          window.scrollTo(0, 0)\n        }\n\n        cache.set((c) => ({ ...c, next: {} }))\n        weakScrolledElements = new WeakSet<any>()\n      }\n    })\n\n    return () => {\n      document.removeEventListener('scroll', onScroll)\n      unsubOnBeforeLoad()\n      unsubOnResolved()\n    }\n  }, [])\n}\n\nexport function ScrollRestoration(props: ScrollRestorationOptions) {\n  useScrollRestoration(props)\n  return null\n}\n\nexport function useElementScrollRestoration(\n  options: (\n    | {\n        id: string\n        getElement?: () => Element | undefined | null\n      }\n    | {\n        id?: string\n        getElement: () => Element | undefined | null\n      }\n  ) & {\n    getKey?: (location: ParsedLocation) => string\n  },\n) {\n  const router = useRouter()\n  const getKey = options?.getKey || defaultGetKey\n\n  let elementSelector = ''\n\n  if (options.id) {\n    elementSelector = `[data-scroll-restoration-id=\"${options.id}\"]`\n  } else {\n    const element = options.getElement?.()\n    if (!element) {\n      return\n    }\n    elementSelector = getCssSelector(element)\n  }\n\n  const restoreKey = getKey(router.latestLocation)\n  const cacheKey = [restoreKey, elementSelector].join(delimiter)\n  return cache.state.cached[cacheKey]\n}\n\nfunction getCssSelector(el: any): string {\n  let path = [],\n    parent\n  while ((parent = el.parentNode)) {\n    path.unshift(\n      `${el.tagName}:nth-child(${\n        ([].indexOf as any).call(parent.children, el) + 1\n      })`,\n    )\n    el = parent\n  }\n  return `${path.join(' > ')}`.toLowerCase()\n}\n"],"names":["useLayoutEffect","window","React","useEffect","windowKey","delimiter","weakScrolledElements","WeakSet","sessionsStorage","sessionStorage","cache","storageKey","state","JSON","parse","getItem","cached","next","set","updater","functionalUpdate","setItem","stringify","undefined","defaultGetKey","location","key","useScrollRestoration","options","router","useRouter","getKey","history","scrollRestoration","onScroll","event","has","target","add","elementSelector","document","attrId","getAttribute","getCssSelector","c","scrollX","NaN","scrollY","addEventListener","unsubOnBeforeLoad","subscribe","pathChanged","restoreKey","fromLocation","entry","element","querySelector","scrollLeft","scrollTop","join","unsubOnResolved","resetNextScroll","toLocation","windowRestored","cacheKey","split","scrollTo","removeEventListener","ScrollRestoration","props","useElementScrollRestoration","id","getElement","latestLocation","el","path","parent","parentNode","unshift","tagName","indexOf","call","children","toLowerCase"],"mappings":"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"}