{"version":3,"file":"useStore.js","sources":["../../src/useStore.ts"],"sourcesContent":["import * as React from 'react'\nimport { NonNullableUpdater, functionalUpdate, shallow } from './utils'\n\nexport type Store<T> = {\n  getState: () => T\n  setState: (\n    updater: NonNullableUpdater<T>,\n    opts?: {\n      notify?: boolean\n    },\n  ) => void\n  subscribe: (listener: (state: T) => void) => () => void\n}\n\nexport const createStore = <T>(\n  createState: (\n    setState: (nextState: T) => void,\n    getState: () => T,\n    api: Store<T>,\n  ) => T,\n  opts?: {\n    onUpdate?: (nextState: T, prevState: T) => T\n  },\n): Store<T> => {\n  let state: T\n  const listeners = new Set<\n    (nextState: T, prevState: T) => void | Promise<void>\n  >()\n\n  const setState = (\n    updater: NonNullableUpdater<T>,\n    opts2?: {\n      notify?: boolean\n    },\n  ) => {\n    const previousState = state\n    state = functionalUpdate(updater, state)\n    if (opts?.onUpdate) {\n      state = opts.onUpdate(state, previousState)\n    }\n    if (opts2?.notify ?? true) {\n      listeners.forEach((listener) => listener(state, previousState))\n    }\n  }\n\n  const getState = () => state\n\n  const subscribe = (\n    listener: (nextState: T, prevState: T) => void | Promise<void>,\n  ) => {\n    listeners.add(listener)\n    return () => listeners.delete(listener)\n  }\n\n  const api = { setState, getState, subscribe }\n  state = createState(setState, getState, api)\n\n  return api\n}\n\nconst defaultSelector = <T>(state: T) => state as any\n\nexport function useStore<State, Slice>(\n  store: Store<State>,\n  selector_?: (state: State) => Slice,\n  // areEqual: (a: Slice, b: Slice) => boolean = shallow,\n) {\n  const state = store.getState()\n  const selector = (selector_ || defaultSelector) as (state: State) => Slice\n  const slice = React.useMemo(() => selector(state), [state])\n\n  const [[sliceFromReducer, storeFromReducer], rerender] = React.useReducer<\n    React.Reducer<readonly [Slice, Store<State>], boolean | undefined>,\n    undefined\n  >(\n    (prev, shouldSync?: boolean) => {\n      if (shouldSync) {\n        return [slice, store]\n      }\n\n      const nextState = store.getState()\n\n      if (Object.is(state, nextState) && prev[1] === store) {\n        return prev\n      }\n\n      const nextSlice = selector(nextState)\n\n      if (shallow(prev[0], nextSlice) && prev[1] === store) {\n        return prev\n      }\n\n      return [nextSlice, store]\n    },\n    undefined,\n    () => [slice, store],\n  )\n\n  React.useEffect(() => {\n    const unsubscribe = store.subscribe(() =>\n      (rerender as React.DispatchWithoutAction)(),\n    )\n    ;(rerender as React.DispatchWithoutAction)()\n    return unsubscribe\n  }, [store])\n\n  if (storeFromReducer !== store) {\n    rerender(true)\n    return slice\n  }\n\n  if (!shallow(sliceFromReducer, slice)) {\n    rerender(true)\n  }\n\n  return sliceFromReducer\n}\n"],"names":["createStore","createState","opts","state","listeners","Set","setState","updater","opts2","previousState","functionalUpdate","onUpdate","notify","forEach","listener","getState","subscribe","add","delete","api","defaultSelector","useStore","store","selector_","selector","slice","React","useMemo","sliceFromReducer","storeFromReducer","rerender","useReducer","prev","shouldSync","nextState","Object","is","nextSlice","shallow","undefined","useEffect","unsubscribe"],"mappings":"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"}